# チャットボットシステムのアーキテクチャ

## 概要

このドキュメントでは、チャットボットシステムのアーキテクチャについて説明します。本システムはフロントエンドとバックエンドを分離したモダンなWebアプリケーションアーキテクチャを採用しています。

## システム全体のアーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   フロントエンド   │◄──►│   バックエンド    │◄──►│   Qdrant DB     │
│   (React)       │    │   (FastAPI)     │    │   (Vector DB)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       ▼                       ▼
         │              ┌─────────────────┐    ┌─────────────────┐
         │              │    Ollama       │    │   設定ファイル    │
         │              │ (Embedding)     │    │   (TOML)       │
         │              └─────────────────┘    └─────────────────┘
         │
         ▼
┌─────────────────┐
│   ユーザー       │
└─────────────────┘
```

## フロントエンドアーキテクチャ

### 技術スタック
- **React + TypeScript**: モダンなUIフレームワークと型安全な開発
- **Material-UI (MUI)**: UIコンポーネントライブラリ
- **Axios**: HTTPクライアント
- **React Router**: クライアントサイドルーティング
- **React Query**: サーバーステート管理
- **Zustand**: クライアントサイド状態管理

### コンポーネント構造
```
src/
├── components/           # 再利用可能なUIコンポーネント
│   ├── common/          # 共通コンポーネント
│   ├── layout/          # レイアウトコンポーネント
│   └── forms/           # フォームコンポーネント
├── pages/              # ページコンポーネント
├── hooks/              # カスタムフック
├── services/           # APIサービス
├── utils/              # ユーティリティ関数
├── types/              # TypeScript型定義
└── store/              # 状態管理
```

### 主要コンポーネント
1. **ChatInterface**: チャットボットとの対話インターフェース
2. **LLMConfigSettings**: LLM設定管理画面
3. **KnowledgeManagement**: ナレッジベース管理画面
4. **AppLayout**: アプリケーションの全体レイアウト

### 状態管理
- **グローバル状態**: Zustandを使用した軽量な状態管理
- **サーバーステート**: React Queryを使用したAPI状態管理
- **ローカル状態**: コンポーネント内のuseState

### API通信
- **Axiosインスタンス**: ベースURLとインターセプターを設定
- **エラーハンドリング**: グローバルエラーハンドリングとユーザーへの通知
- **認証**: JWTトークンを使用した認証（将来の拡張用）

## バックエンドアーキテクチャ

### 技術スタック
- **FastAPI**: 高性能なPython Webフレームワーク
- **Pydantic**: データバリデーションとシリアライゼーション
- **LangChain**: LLMアプリケーションフレームワーク
- **Qdrant**: ベクトルデータベース
- **Ollama**: 埋め込みモデル
- **TOML**: 設定ファイルフォーマット
- **Python Logging**: 構造化ロギング

### モジュール構造
```
api/
├── core/               # コアモジュール
│   ├── config_manager.py    # 統合設定管理
│   ├── utils.py            # 共通ユーティリティ
│   ├── qdrant_manager.py   # Qdrant管理
│   └── config_watcher.py   # 設定変更監視
├── routes/             # APIルート
│   ├── chat.py            # チャット関連ルート
│   ├── llm_config.py      # LLM設定関連ルート
│   ├── knowledge.py       # ナレッジ管理関連ルート
│   └── config.py          # 設定管理関連ルート
├── services/           # ビジネスロジック
│   ├── chat_service.py    # チャットサービス
│   └── base_service.py    # ベースサービスクラス
├── models/             # データモデル
│   ├── config_models.py   # 設定関連モデル
│   └── chat_models.py     # チャット関連モデル
└── tests/              # テストコード
```

### 設定管理
- **統合設定管理**: `ConfigManager`クラスによる一元管理
- **TOMLフォーマット**: 人間が読みやすい設定ファイル
- **動的設定更新**: 実行時の設定変更と即時反映
- **設定バリデーション**: Pydanticモデルによる型安全な設定

### サービス層
- **BaseService**: すべてのサービスの基底クラス
- **ChatService**: チャット関連のビジネスロジック
- **サービスレジストリ**: サービスのライフサイクル管理

### エラーハンドリング
- **カスタム例外**: アプリケーション固有の例外クラス
- **構造化エラー**: 一貫したエラーレスポンス
- **エラーロギング**: 詳細なエラー情報の記録
- **エラーデコレータ**: ルート関数でのエラーハンドリング

### ロギング
- **構造化ロギング**: JSON形式のログ出力
- **ログレベル**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **ログローテーション**: ファイルサイズと日付によるローテーション
- **パフォーマンスロギング**: リクエスト処理時間の記録

## データフロー

### チャット処理フロー
```
ユーザー入力
    ↓
フロントエンド (React)
    ↓
APIリクエスト (/api/chat/send)
    ↓
バックエンド (FastAPI)
    ↓
ChatService
    ↓
LangChain + LLM
    ↓
Qdrant検索 (オプション)
    ↓
LLM応答生成
    ↓
APIレスポンス
    ↓
フロントエンド (React)
    ↓
ユーザーへの表示
```

### 設定更新フロー
```
設定変更
    ↓
フロントエンド (React)
    ↓
APIリクエスト (/api/config/update)
    ↓
バックエンド (FastAPI)
    ↓
ConfigManager
    ↓
設定ファイル更新 (TOML)
    ↓
設定変更通知
    ↓
関連サービスの更新
    ↓
APIレスポンス
    ↓
フロントエンド (React)
    ↓
UIの更新
```

### ナレッジ管理フロー
```
ドキュメント追加
    ↓
フロントエンド (React)
    ↓
APIリクエスト (/api/knowledge/document)
    ↓
バックエンド (FastAPI)
    ↓
QdrantManager
    ↓
ドキュメントのチャンキング
    ↓
埋め込み生成 (Ollama)
    ↓
Qdrantへの保存
    ↓
APIレスポンス
    ↓
フロントエンド (React)
    ↓
UIの更新
```

## セキュリティ

### 認証と認可
- **JWTトークン**: 状態lessな認証（将来の拡張用）
- **APIキー**: 外部サービスへのアクセス制御
- **CORS**: クロスオリジンリソース共有の制限

### データ保護
- **入力バリデーション**: ユーザー入力の検証
- **SQLインジェクション対策**: パラメータ化されたクエリ
- **XSS対策**: ユーザー入力のサニタイズ

### 環境変数
- **機密情報**: 環境変数による管理
- **設定分離**: 開発/本番環境の設定分離

## パフォーマンス

### キャッシュ戦略
- **レスポンスキャッシュ**: APIレスポンスのキャッシュ
- **埋め込みキャッシュ**: 頻繁に使用される埋め込みのキャッシュ
- **静的アセット**: フロントエンドアセットのキャッシュ

### 非同期処理
- **非同期API**: FastAPIの非同期処理
- **ストリーミング**: チャット応答のストリーミング
- **バックグラウンドタスク**: 時間のかかる処理の非同期化

### スケーラビリティ
- **水平スケーリング**: コンテナベースのデプロイ
- **負荷分散**: リクエストの分散処理
- **データベーススケーリング**: Qdrantのクラスタリング

## 監視と運用

### ログ監視
- **構造化ログ**: 機械可読なログ形式
- **エラートラッキング**: エラーの集計と分析
- **パフォーマンスメトリクス**: レスポンスタイムの監視

### ヘルスチェック
- **サービスヘルスチェック**: 各サービスの状態監視
- **依存関係チェック**: 外部サービスの接続確認
- **リソース監視**: CPU、メモリ、ディスク使用量の監視

### デプロイ
- **Dockerコンテナ**: 環境に依存しないデプロイ
- **Docker Compose**: マルチコンテナアプリケーションの管理
- **CI/CDパイプライン**: 自動テストとデプロイ

## 将来の拡張

### 機能拡張
- **マルチテナンシー**: 複数ユーザーのサポート
- **プラグインシステム**: 機能の拡張性向上
- **Webhook**: 外部システムとの連携

### 技術的改善
- **マイクロサービス**: サービスの分割
- **イベントドリブンアーキテクチャ**: 非同期処理の強化
- **GraphQL**: APIの柔軟性向上